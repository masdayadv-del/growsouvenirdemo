/* ==================================================
   GROW SOUVENIR SYSTEM - BACKEND (FINAL V25: HPP & DEPOSIT FEATURES)
   ================================================== */

const CONFIG = {
  SS_ID: SpreadsheetApp.getActiveSpreadsheet().getId(),
  SHEET_MASTER: "MasterProduk",
  SHEET_EXPENSE: "DataPengeluaran",
  SHEET_USER: "DataUser",
  SHEET_SETOR: "SetorModal",
  TIMEZONE: "Asia/Jakarta",
  CACHE_KEY: "GROW_DATA_CACHE_V25", // Cache Key Updated
  API_TOKEN: "GROW_SECURE_2026",

  STORE: {
    NAME: "Grow Souvenir and Advertising",
    ADDR: "Jl. Vetpur Raya III, Gg. Amat Salim, Kec. Percut Sei Tuan",
    CONTACT: "0815 8899 407 / 0877 1126 4841"
  },

  // STYLE PDF (HEADER TABEL BIRU, BODY MODERN)
  STYLE: `
    @page { size: A4; margin: 10mm; }
    body { font-family: 'Helvetica', sans-serif; padding: 0; color: #444; font-size: 9px; -webkit-print-color-adjust: exact; }
    
    /* HEADER DOKUMEN (TABLE BASED) */
    .page-header { background-color: #ffffff; padding: 10px 20px 0 20px; }
    .header-table { width: 100%; border-bottom: 2px solid #1E3A8A; padding-bottom: 10px; }
    
    .brand-name { font-size: 18px; font-weight: bold; color: #1E3A8A; text-transform: uppercase; margin-bottom: 2px; }
    .brand-nib { font-size: 10px; color: #333; font-weight: bold; margin-bottom: 3px; }
    .brand-info { font-size: 8px; color: #555; line-height: 1.3; }
    .doc-title { font-size: 20px; font-weight: 900; color: #E5E7EB; text-align: right; letter-spacing: 2px; text-transform: uppercase; }
    .doc-meta { font-size: 9px; color: #000; text-align: right; margin-top: 4px; font-weight: bold; }

    /* UTILS */
    .text-blue { color: #2563EB; } 
    .text-red { color: #DC2626; } 
    .text-green { color: #16A34A; } 
    .text-orange { color: #F59E0B; }
    
    /* KPI CARDS (ROUNDED & MODERN) */
    .summary-grid { width: 100%; border-collapse: separate; border-spacing: 10px 0; margin-bottom: 25px; table-layout: fixed; }
    .card { 
        padding: 12px; 
        border: 1px solid #E5E7EB; 
        border-radius: 12px; 
        vertical-align: top; 
        background-color: #FAFAFA;
    }
    .card-lbl { font-size: 8px; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; color: #666; letter-spacing: 0.5px; }
    .card-val { font-size: 12px; font-weight: bold; }
    
    .bg-blue { background-color: #EFF6FF; border: 1px solid #DBEAFE; }
    .bg-red { background-color: #FEF2F2; border: 1px solid #FEE2E2; }
    .bg-green { background-color: #F0FDF4; border: 1px solid #DCFCE7; }
    .bg-orange { background-color: #FFFBEB; border: 1px solid #FEF3C7; }

    /* TABEL DATA */
    .data-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; table-layout: fixed; }
    
    /* HEADER TABEL: BIRU ROYAL & TEKS PUTIH (FIXED) */
    .data-table th { 
        background-color: #1E3A8A !important; 
        color: #ffffff !important; 
        padding: 10px 5px; 
        font-size: 8px; 
        text-transform: uppercase; 
        font-weight: bold; 
        text-align: center; 
        vertical-align: middle; 
        border: none;
    }
    
    .data-table td { padding: 8px 5px; border-bottom: 1px solid #EEE; color: #333; font-size: 9px; vertical-align: middle; word-wrap: break-word; }
    .data-table tr:nth-child(even) td { background-color: #FAFAFA; }
    .total-row td { border-top: 2px solid #1E3A8A !important; border-bottom: none !important; font-weight: bold; background-color: #fff !important; padding-top: 10px; }

    /* ALIGNMENT */
    .al-left { text-align: left; } .al-center { text-align: center; } .al-right { text-align: right; }
    .font-bold { font-weight: bold; }
    .sub-text { font-size: 7px; color: #888; display: block; margin-top: 2px; }

    /* STEMPEL */
    .stamp-container { text-align: center; padding-top: 25px; }
    .stamp-box { display: inline-block; padding: 8px 25px; border-radius: 8px; font-weight: 900; font-size: 18px; text-transform: uppercase; transform: rotate(-5deg); letter-spacing: 3px; opacity: 0.8; }
    .stamp-lunas { border: 3px solid #16A34A; color: #16A34A; } 
    .stamp-belum { border: 3px solid #DC2626; color: #DC2626; }
    
    .section-head { font-size: 10px; font-weight: bold; color: #1E3A8A; margin-top: 25px; border-bottom: 1px solid #E5E7EB; padding-bottom: 4px; text-transform: uppercase; margin-bottom: 10px; letter-spacing: 1px; }
    
    /* FOOTER */
    .footer { margin-top: 50px; text-align: center; font-size: 8px; color: #888; border-top: 1px solid #EEE; padding-top: 15px; }
  `
};

/* ==================================================
   API HANDLER
   ================================================== */

function doGet(e) { return handleRequest(e); }
function doPost(e) { return handleRequest(e); }

function handleRequest(e) {
  try {
    let action = e.parameter.action;
    let postData = null;
    if (e.postData && e.postData.contents) {
      postData = JSON.parse(e.postData.contents);
      if (!action && postData.action) action = postData.action;
    }

    if (action === 'ping') return ContentService.createTextOutput("Pong");
    if (action === 'login') return sendJSON(loginUser(postData.username, postData.password));

    if (!postData || postData.token !== CONFIG.API_TOKEN) return sendJSON({ success: false, message: "Token Tidak Valid" });

    // READ
    if (action === 'getInitialData') {
      const cache = CacheService.getScriptCache();
      const cachedData = cache.get(CONFIG.CACHE_KEY);
      if (cachedData) return ContentService.createTextOutput(cachedData).setMimeType(ContentService.MimeType.JSON);
      
      const freshData = getInitialData();
      const jsonStr = JSON.stringify(freshData);
      try { cache.put(CONFIG.CACHE_KEY, jsonStr, 1800); } catch (e) {}
      return ContentService.createTextOutput(jsonStr).setMimeType(ContentService.MimeType.JSON);
    }
    else if (action === 'getTransactionDetail') return sendJSON(getTransactionDetail(postData.id, postData.date));
    else if (action === 'generateInvoice') return sendJSON(generateInvoice(postData.id, postData.date));
    else if (action === 'generatePDFReport') return sendJSON(generatePDFReport(postData));
    else if (action === 'generateAnnualReport') return sendJSON(generateAnnualReport(postData));
    else if (action === 'generateExpenseOnlyReport') return sendJSON(generateExpenseOnlyReport(postData));
    
    // USER MANAGEMENT (OWNER PANEL)
    else if (action === 'getUsers') return sendJSON(getUsers());

    // WRITE
    const lock = LockService.getScriptLock();
    if (lock.tryLock(5000)) {
      try {
        let result = {};
        let isWrite = false;
        if (action === 'saveTransaction') { result = saveTransaction(postData); isWrite = true; }
        else if (action === 'deleteTransaction') { result = deleteTransaction(postData.id, postData.date); isWrite = true; }
        else if (action === 'deleteExpense') { result = deleteExpense(postData.id); isWrite = true; }
        else if (action === 'saveExpense') { result = saveExpense(postData); isWrite = true; }
        else if (action === 'saveDeposit') { result = saveDeposit(postData.amount, postData.note, postData.bank); isWrite = true; }
        else if (action === 'addNewProduct') { result = addNewProduct(postData.category, postData.name); isWrite = true; }
        // User Management Write
        else if (action === 'saveUser') { result = saveUser(postData); isWrite = true; }
        else if (action === 'deleteUser') { result = deleteUser(postData.username); isWrite = true; }
        
        else { result = { success: false, message: "Aksi Tidak Dikenal" }; }

        if (isWrite && result.success) CacheService.getScriptCache().remove(CONFIG.CACHE_KEY);
        return sendJSON(result);
      } finally { lock.releaseLock(); }
    } else { return sendJSON({ success: false, message: "Server Sibuk" }); }

  } catch (err) { return sendJSON({ success: false, message: err.toString() }); }
}

function sendJSON(data) { return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON); }

// --- AUTH & DATA LOGIC ---
function loginUser(username, password) {
  try {
    const ss = SpreadsheetApp.openById(CONFIG.SS_ID);
    const sheet = getOrSetupSheet(ss, CONFIG.SHEET_USER, ["Username", "Password", "Role", "Nama Lengkap", "Foto"]);
    if (sheet.getLastRow() === 1) { 
        sheet.appendRow(["owner", "12345", "Owner", "Boss Owner", ""]);
        sheet.appendRow(["admin", "12345", "Admin", "Admin Toko", ""]); 
        sheet.appendRow(["kasir", "kasir1", "Kasir", "Kasir Toko", ""]);
        sheet.appendRow(["demo", "demo123", "Demo", "Preview Demo", ""]); 
    }
    const data = sheet.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
      if (String(data[i][0]).toLowerCase() === String(username).toLowerCase() && String(data[i][1]) === String(password)) {
        return { success: true, user: { username: data[i][0], role: data[i][2], name: data[i][3], photo: data[i][4] || "" } };
      }
    }
    return { success: false, message: "Username/Password Salah" };
  } catch (e) { return { success: false, message: e.message }; }
}

// --- USER MANAGEMENT ---
function getUsers() {
    try {
        const ss = SpreadsheetApp.openById(CONFIG.SS_ID);
        const sheet = getOrSetupSheet(ss, CONFIG.SHEET_USER, ["Username", "Password", "Role", "Nama Lengkap", "Foto"]);
        const data = sheet.getDataRange().getValues();
        let users = [];
        for (let i = 1; i < data.length; i++) {
             // Return password as well for editing, or keep it hidden if preferred. For simplicity in this owner panel, we return it.
            users.push({ username: data[i][0], password: data[i][1], role: data[i][2], name: data[i][3], photo: data[i][4] || "" });
        }
        return { success: true, users: users };
    } catch (e) { return { success: false, message: e.message }; }
}

function saveUser(d) {
    try {
        const ss = SpreadsheetApp.openById(CONFIG.SS_ID);
        const sheet = getOrSetupSheet(ss, CONFIG.SHEET_USER, ["Username", "Password", "Role", "Nama Lengkap", "Foto"]);
        const data = sheet.getDataRange().getValues();
        
        // Cek duplicate username
        let rowIdx = -1;
        for (let i = 1; i < data.length; i++) {
            if (String(data[i][0]).toLowerCase() === String(d.username).toLowerCase()) {
                rowIdx = i + 1;
                break;
            }
        }

        // Jika mode EDIT (isEdit flag true or duplicate found but we want to update)
        // Note: ID in this case is the username. If username is changed, it requires delete+add logic.
        // Simplified: Username cannot be changed. If ID matches, update.
        
        let targetRow = rowIdx;
        if (d.isEdit && rowIdx > 0) {
            // Update
             sheet.getRange(targetRow, 2).setValue(d.password);
             sheet.getRange(targetRow, 3).setValue(d.role);
             sheet.getRange(targetRow, 4).setValue(d.name);
             if (d.photo) sheet.getRange(targetRow, 5).setValue(d.photo);
        } else {
             if (rowIdx > 0) return { success: false, message: "Username sudah ada!" };
             // Insert New
             sheet.appendRow([d.username, d.password, d.role, d.name, d.photo || ""]);
        }
        
        return { success: true };
    } catch (e) { return { success: false, message: e.message }; }
}

function deleteUser(u) {
    try {
        const ss = SpreadsheetApp.openById(CONFIG.SS_ID);
        const sheet = ss.getSheetByName(CONFIG.SHEET_USER);
        if(!sheet) return {success:false, message:"Data tidak ditemukan"};
        const data = sheet.getDataRange().getValues();
        for(let i=1; i<data.length; i++){
            if(String(data[i][0]) === String(u)){
                sheet.deleteRow(i+1);
                return { success: true };
            }
        }
        return { success: false, message: "User tidak ditemukan" };
    } catch (e) { return { success: false, message: e.message }; }
}

function getInitialData() {
  const ss = SpreadsheetApp.openById(CONFIG.SS_ID);
  const now = new Date(); 
  const curMonthIdx = now.getMonth(); 
  const curYear = now.getFullYear();
  
  const sTrans = ss.getSheetByName("Trans_" + Utilities.formatDate(now, CONFIG.TIMEZONE, "MMMyyyy"));
  const sProd = ss.getSheetByName(CONFIG.SHEET_MASTER);
  const sExp = ss.getSheetByName(CONFIG.SHEET_EXPENSE);
  const sSetor = ss.getSheetByName(CONFIG.SHEET_SETOR);

  // 1. DATA PRODUK
  let products = [];
  if (sProd && sProd.getLastRow() > 1) {
    const vals = sProd.getRange(2, 1, sProd.getLastRow() - 1, 2).getValues();
    for(let i=0; i<vals.length; i++) { if(vals[i][1]) products.push({ category: vals[i][0], name: vals[i][1] }); }
  } else { products.push({ category: "Souvenir", name: "Mug Custom" }); }

  // 2. DATA PENGELUARAN
  let totalExpense = 0, recentExpenses = [];
  let expenseDescSet = new Set(); // Store unique descriptions
  
  if (sExp && sExp.getLastRow() > 1) {
    const vals = sExp.getRange(2, 1, sExp.getLastRow() - 1, 5).getValues();
    for (let i = vals.length - 1; i >= 0; i--) {
        const r = vals[i]; if(!r[1]) continue;
        const d = new Date(r[1]);
        const isCurMonth = d.getMonth() === curMonthIdx && d.getFullYear() === curYear;
        
        // Collect Description
        if (r[3]) expenseDescSet.add(r[3]);

        if (isCurMonth) { totalExpense += Number(r[4] || 0); }
        
        // Logic: Include ALL Current Month data for KPI, OR keep at least 15 items
        if (isCurMonth || recentExpenses.length < 15) { 
          recentExpenses.push({ 
            id: r[0], 
            date: Utilities.formatDate(d, CONFIG.TIMEZONE, "dd MMM"),
            isoDate: Utilities.formatDate(d, CONFIG.TIMEZONE, "yyyy-MM-dd"), // Added for filtering
            cat: r[2], 
            desc: r[3], 
            amount: Number(r[4]) 
          }); 
        }
    }
  }

  // 3. DATA TRANSAKSI (Updated: Self-Correcting Status)
  let recentHistory = [], stats = { omzet: 0, grossProfit: 0, netProfit: 0 }, totalHPP = 0;
  let totalRecoveredHPP = 0; // New: Track actual capital recovered (cash)
  let customerSet = new Set(); // Store unique customers
  let productSales = {}; // Track product sales
  
  // Initialize historyKPI OUTSIDE to ensure it's always defined
  let historyKPI = {
    all: { count: 0, total: 0 },
    lunas: { count: 0, total: 0 },
    belum: { count: 0, total: 0 }
  };
  
  if (sTrans && sTrans.getLastRow() > 1) {
    const vals = sTrans.getRange(2, 1, sTrans.getLastRow() - 1, 13).getValues();
    let grouped = {}; let order = [];
    
    for (let i = 0; i < vals.length; i++) {
        const r = vals[i]; if(!r[0]) continue;
        const id = String(r[0]);
        const custName = r[2];
        if (custName && custName !== "Umum") customerSet.add(custName); // Collect Customer

        // Aggregate Product Sales for Top Seller
        if (r[3]) productSales[r[3]] = (productSales[r[3]] || 0) + Number(r[4]);

        const subTotal = Number(r[7]); 
        const profitItem = Number(r[8]);
        const hppItem = Number(r[4]) * Number(r[6]); // Qty * Modal
        
        stats.omzet += subTotal; 
        totalHPP += hppItem;

        if (!grouped[id]) {
            grouped[id] = { 
              id: id, 
              dObj: new Date(r[1]), 
              customer: custName, 
              itemCount: 0, 
              firstProduct: r[3], 
              total: 0, 
              totalHpp: 0, 
              totalProfit: 0, // Accumulate profit
              dp: Number(r[9])||0, 
              sisa: 0, 
              status: "", // To be recalculated
              deadline: r[12]?Utilities.formatDate(new Date(r[12]), CONFIG.TIMEZONE, "yyyy-MM-dd"):"",
              items: [] // NEW: Pre-load items
            };
            order.push(id);
        }
        grouped[id].itemCount++; 
        grouped[id].total += subTotal;
        grouped[id].totalHpp += hppItem;
        grouped[id].totalProfit += profitItem;
        
        // NEW: Push item detail to array
        grouped[id].items.push({
            productName: r[3],
            qty: Number(r[4]),
            sellPrice: Number(r[5]),
            costPrice: Number(r[6])
        });
    }
    
    // Update historyKPI count
    historyKPI.all.count = order.length;
    
    // Calculate KPI Totals, Fix Sisa, & SELF-CORRECT STATUS
    for (let id in grouped) {
        const g = grouped[id];
        g.sisa = g.total - g.dp;
        
        // SELF-CORRECTING LOGIC: Trust arithmetic over text
        // If sisa is 0 or less, it IS PAID (LUNAS), regardless of what sheet says
        const realStatus = g.sisa <= 0 ? "LUNAS" : "BELUM LUNAS";
        g.status = realStatus; 
        
        historyKPI.all.total += g.total;
        
        if (g.status === 'LUNAS') {
            historyKPI.lunas.count++;
            historyKPI.lunas.total += g.total;
        } else {
            historyKPI.belum.count++;
            historyKPI.belum.total += g.sisa; // Use Sisa (Receivables) for Belum Lunas
        }
        
        // NEW PROFIT LOGIC: Cash Basis (DP included)
        // Profit = Uang Masuk (Lunas=Total, Belum=DP) - HPP
        const cashIn = (g.status === 'LUNAS') ? g.total : g.dp;
        stats.grossProfit += (cashIn - g.totalHpp);

        // MODAL CAIR (RECOVERED CAPITAL):
        // Uang modal yang benar-benar sudah diterima di tangan
        totalRecoveredHPP += Math.min(cashIn, g.totalHpp);
    }

    const startIdx = Math.max(0, order.length - 25); // Limit 25
    for (let i = startIdx; i < order.length; i++) {
        const g = grouped[order[i]];
        recentHistory.push({ 
          id: g.id, 
          displayDate: Utilities.formatDate(g.dObj, CONFIG.TIMEZONE, "dd MMM"), 
          fullDate: Utilities.formatDate(g.dObj, CONFIG.TIMEZONE, "dd MMM yyyy HH:mm"),
          isoDate: Utilities.formatDate(g.dObj, CONFIG.TIMEZONE, "yyyy-MM-dd"), 
          customer: g.customer, 
          product: g.itemCount > 1 ? `${g.firstProduct} (+${g.itemCount-1} item)` : g.firstProduct, 
          total: g.total, 
          hpp: g.totalHpp,
          dp: g.dp, 
          sisa: g.sisa, 
          status: g.status, 
          deadline: g.deadline,
          items: g.items, // Pre-loaded items
          timestamp: g.dObj.toISOString() // NEW: Preserve exact time for edits
        });
    }
    recentHistory.reverse();
  }
  stats.netProfit = stats.grossProfit - totalExpense;

  // Find Top Product
  let topProd = { name: '-', qty: 0 };
  for (const [name, qty] of Object.entries(productSales)) {
      if (qty > topProd.qty) { topProd = { name, qty }; }
  }

  // 4. DATA SETOR MODAL (Updated: Fetch History)
  let totalDisetor = 0, depositHistory = [];
  if (sSetor && sSetor.getLastRow() > 1) {
    const vals = sSetor.getRange(2, 1, sSetor.getLastRow() - 1, 5).getValues();
    // Loop untuk total
    for (let i = 0; i < vals.length; i++) { 
      if (new Date(vals[i][1]).getMonth() === curMonthIdx) totalDisetor += Number(vals[i][2]); 
    }
    // Loop untuk history (ambil 10 terakhir)
    for (let i = vals.length - 1; i >= Math.max(0, vals.length - 10); i--) {
       depositHistory.push({
         date: Utilities.formatDate(new Date(vals[i][1]), CONFIG.TIMEZONE, "dd MMM HH:mm"),
         amount: Number(vals[i][2]),
         note: vals[i][3],
         bank: vals[i][4] || "Mandiri"
       });
    }
  }

  return { 
    products: products, 
    customers: Array.from(customerSet).sort(), // Return sorted customer list
    expenseDescriptions: Array.from(expenseDescSet).sort(), // Return sorted expense descriptions
    history: recentHistory, 
    expenses: recentExpenses, 
    deposits: depositHistory,
    stats: { ...stats, totalExpense, totalHPP }, 
    modalStats: { totalHPP, totalDisetor, modalGantung: totalRecoveredHPP - totalDisetor },
    historyKPI: historyKPI,
    topProduct: topProd // Return Top Product
  };
}

// --- CRUD ---
function toRoman(num) { const r=["I","II","III","IV","V","VI","VII","VIII","IX","X","XI","XII"]; return r[num]||""; }
function getCurrentSheetName() { return "Trans_" + Utilities.formatDate(new Date(), CONFIG.TIMEZONE, "MMMyyyy"); }
function getSheetNameByDate(dateStr) { if (!dateStr) return getCurrentSheetName(); return "Trans_" + Utilities.formatDate(new Date(dateStr), CONFIG.TIMEZONE, "MMMyyyy"); }
function getOrSetupSheet(ss, name, headers) { let sheet = ss.getSheetByName(name); if (!sheet) { sheet = ss.insertSheet(name); sheet.appendRow(headers); sheet.setFrozenRows(1); sheet.getRange(1, 1, 1, headers.length).setFontWeight("bold").setBackground("#1e3a8a").setFontColor("white"); } return sheet; }
function deleteTransactionRows(sheet, id) { const data = sheet.getDataRange().getValues(); for (let i = data.length - 1; i >= 0; i--) { if (String(data[i][0]) === String(id)) sheet.deleteRow(i + 1); } }

function getTransactionDetail(id, dateStr) { try { const ss = SpreadsheetApp.openById(CONFIG.SS_ID); const sheetName = getSheetNameByDate(dateStr); const sheet = ss.getSheetByName(sheetName); if (!sheet) throw new Error("Data bulanan tidak ditemukan"); const data = sheet.getDataRange().getValues(); const rows = data.filter(r => String(r[0]) === String(id)); if (rows.length === 0) throw new Error("ID Transaksi tidak ditemukan"); const items = rows.map(r => ({ productName: r[3], qty: Number(r[4]), sellPrice: Number(r[5]), costPrice: Number(r[6]) })); const transDate = rows[0][1]; return { success: true, items: items, transactionDate: transDate }; } catch (e) { return { success: false, message: e.message }; } }
function deleteTransaction(id, dateStr) { 
  try { 
    const ss = SpreadsheetApp.openById(CONFIG.SS_ID); 
    const sheetName = dateStr ? getSheetNameByDate(dateStr) : getCurrentSheetName();
    const sheet = ss.getSheetByName(sheetName);
    if (!sheet) throw new Error("Sheet tidak ditemukan: " + sheetName);
    deleteTransactionRows(sheet, id); 
    return { success: true }; 
  } catch (e) { return { success: false, message: e.message }; } 
}
function saveExpense(form) { 
  try { 
    const ss = SpreadsheetApp.openById(CONFIG.SS_ID); 
    const sheet = getOrSetupSheet(ss, CONFIG.SHEET_EXPENSE, ["ID", "Tanggal", "Kategori", "Keterangan", "Nominal"]); 
    const id = form.id || Utilities.getUuid(); // Use provided ID or generate new
    const timestamp = new Date();
    
    // Check for Edit
    const data = sheet.getDataRange().getValues();
    let found = false;
    
    for (let i = 1; i < data.length; i++) {
      if (String(data[i][0]) === String(id)) {
         // Found: Update
         sheet.getRange(i + 1, 3, 1, 3).setValues([[form.category, form.desc, form.amount]]);
         found = true;
         break;
      }
    }
    
    if (!found) {
      // Not Found: Append (New)
      sheet.appendRow([id, timestamp, form.category, form.desc, form.amount]); 
    }
    return { success: true }; 
  } catch (e) { return { success: false, message: e.message }; } 
}

function deleteExpense(id) {
  try {
    const ss = SpreadsheetApp.openById(CONFIG.SS_ID);
    const sheet = ss.getSheetByName(CONFIG.SHEET_EXPENSE);
    if (!sheet) throw new Error("Sheet Expense tidak ditemukan");
    
    const data = sheet.getDataRange().getValues();
    for (let i = data.length - 1; i >= 0; i--) {
      if (String(data[i][0]) === String(id)) {
        sheet.deleteRow(i + 1);
        return { success: true };
      }
    }
    throw new Error("ID tidak ditemukan");
  } catch (e) { return { success: false, message: e.message }; }
}
function saveDeposit(amount, note, bank) { try { const ss = SpreadsheetApp.openById(CONFIG.SS_ID); getOrSetupSheet(ss, "SetorModal", ["ID", "Waktu", "Nominal", "Keterangan", "Bank"]).appendRow([Utilities.getUuid(), new Date(), amount, note, bank || "Mandiri"]); return { success: true }; } catch (e) { return { success: false, message: e.message }; } }
function addNewProduct(cat, name) { try { const ss = SpreadsheetApp.openById(CONFIG.SS_ID); const s = ss.getSheetByName(CONFIG.SHEET_MASTER); if (s.getDataRange().getValues().some(r => String(r[1]).toLowerCase() === name.toLowerCase())) throw new Error("Produk ada"); s.appendRow([cat, name]); return { success: true }; } catch (e) { return { success: false, message: e.message }; } }
function saveTransaction(form) { try { const ss = SpreadsheetApp.openById(CONFIG.SS_ID); 
    // Fix: Use originalDate if provided used for finding the sheet
    const targetSheetName = form.originalDate ? getSheetNameByDate(form.originalDate) : getCurrentSheetName();
    const sheet = getOrSetupSheet(ss, targetSheetName, ["ID", "Timestamp", "Pelanggan", "Produk", "Qty", "Hrg Jual", "Hrg Modal", "Total Omzet", "Profit Bersih", "DP", "Sisa", "Status", "Deadline"]); 
    const transId = form.id ? String(form.id) : Utilities.getUuid(); 
    
    // Fix: Preserve original Date if editing, otherwise New Date
    const timestamp = form.originalDate ? new Date(form.originalDate) : new Date(); 
    
    if (form.id) deleteTransactionRows(sheet, form.id); 
    let items = form.items || [{ productName: form.productName, qty: form.qty, sellPrice: form.sellPrice, costPrice: form.costPrice }]; 
    let grandTotal = items.reduce((acc, item) => acc + (parseFloat(item.qty||1) * parseFloat(item.sellPrice||0)), 0); 
    let totalDP = parseFloat(form.dp) || 0; 
    const globalSisa = Math.round(grandTotal - totalDP); 
    const globalStatus = globalSisa <= 0 ? "LUNAS" : "BELUM LUNAS"; 
    items.forEach((item, index) => { 
        const qty = parseFloat(item.qty)||1; 
        const sell = parseFloat(item.sellPrice)||0; 
        const cost = parseFloat(item.costPrice)||0; 
        const total = qty * sell; 
        const profit = total - (qty * cost); 
        sheet.appendRow([transId, timestamp, form.customer||"Umum", item.productName, qty, sell, cost, total, profit, (index===0?totalDP:0), (index===0?globalSisa:0), globalStatus, form.deadline ? new Date(form.deadline) : ""]); 
    }); 
    return { success: true }; } catch (e) { return { success: false, message: e.message }; } }

/* ==================================================
   PDF REPORTS (UPDATED V17.1 - BLUE HEADER FIXED)
   ================================================== */
function createPdfResult(html, filename) { return { success: true, filename: filename, data: "data:application/pdf;base64," + Utilities.base64Encode(Utilities.newBlob(html, MimeType.HTML).getAs(MimeType.PDF).getBytes()) }; }
function getHeaderHTML(title, meta1, meta2) { 
  return `<table style="width:100%; border:none; border-spacing:0;"><thead><tr><td>
  <div class="page-header"><table class="header-table"><tr><td width="60%" valign="top"><div class="brand-name">${CONFIG.STORE.NAME}</div><div class="brand-nib">NIB : 0402250003404</div><div class="brand-info">${CONFIG.STORE.ADDR}</div><div class="brand-info">${CONFIG.STORE.CONTACT}</div></td><td width="40%" align="right" valign="top"><div class="doc-title">${title}</div><div class="doc-meta">${meta1}</div><div class="doc-meta">${meta2}</div></td></tr></table></div>
  </td></tr></thead><tbody><tr><td style="padding-top:20px;">`; 
}

// 1. INVOICE
function generateInvoice(id, dateStr) { 
  try { 
    const ss = SpreadsheetApp.openById(CONFIG.SS_ID); 
    // Fix: Use provided dateStr to find correct sheet, or default to current
    const sheetName = dateStr ? getSheetNameByDate(dateStr) : getCurrentSheetName();
    const sheet = ss.getSheetByName(sheetName); 
    if(!sheet) throw new Error("Data tidak ditemukan di sheet " + sheetName); 
    
    const rows = sheet.getDataRange().getValues().filter(r => String(r[0]) === String(id)); 
    if (rows.length === 0) throw new Error("ID tidak ditemukan"); 
    const head = rows[0]; const customerName = head[2]; const dateObj = new Date(head[1]); 
    const invNo = `INV/GSA/${toRoman(dateObj.getMonth())}/${dateObj.getFullYear()}/${String(id).substring(0,3).toUpperCase()}`; 
    const tgl = Utilities.formatDate(dateObj, CONFIG.TIMEZONE, "dd MMM yyyy");
    let deadlineText = head[12] ? Utilities.formatDate(new Date(head[12]), CONFIG.TIMEZONE, "dd MMM yyyy") : "-";
    let itemHtml = "", grandTotal = 0; const totalDP = rows.reduce((acc, r) => acc + Number(r[9]||0), 0); 
    rows.forEach(r => { const subtotal = Number(r[7]); grandTotal += subtotal; itemHtml += `<tr><td class="al-left">${r[3]}</td><td class="al-center">${r[4]}</td><td class="al-right">Rp ${Number(r[5]).toLocaleString('id-ID')}</td><td class="al-right font-bold">Rp ${Number(subtotal).toLocaleString('id-ID')}</td></tr>`; }); 
    const sisa = Math.round(grandTotal - totalDP); const isLunas = (sisa <= 0); 
    let paymentRows = "";
    if(isLunas) { paymentRows = `<tr class="total-row"><td colspan="2"></td><td class="al-right">TOTAL</td><td class="al-right text-blue">Rp ${grandTotal.toLocaleString('id-ID')}</td></tr><tr><td colspan="4" class="stamp-container"><div class="stamp-box stamp-lunas">LUNAS</div></td></tr>`; } 
    else { paymentRows = `<tr class="total-row"><td colspan="2"></td><td class="al-right">TOTAL</td><td class="al-right">Rp ${grandTotal.toLocaleString('id-ID')}</td></tr><tr><td colspan="2"></td><td class="al-right" style="color:#666">DP</td><td class="al-right">Rp ${totalDP.toLocaleString('id-ID')}</td></tr><tr><td colspan="2"></td><td class="al-right text-red font-bold">KURANG</td><td class="al-right text-red font-bold">Rp ${sisa.toLocaleString('id-ID')}</td></tr><tr><td colspan="4" class="stamp-container"><div class="stamp-box stamp-belum">BELUM LUNAS</div></td></tr>`; } 
    
    const html = `<!DOCTYPE html><html><head><style>${CONFIG.STYLE}</style></head><body>${getHeaderHTML("INVOICE", invNo, tgl)}<div style="margin-bottom:20px; display:flex; justify-content:space-between;"><div><div style="font-size:8px; font-weight:bold; color:#888;">KEPADA</div><div style="font-size:12px; font-weight:bold;">${customerName}</div></div><div style="text-align:right;"><div style="font-size:8px; font-weight:bold; color:#DC2626;">DEADLINE</div><div style="font-size:10px; font-weight:bold;">${deadlineText}</div></div></div><table class="data-table"><colgroup><col style="width:45%"><col style="width:10%"><col style="width:20%"><col style="width:25%"></colgroup><thead><tr><th>PRODUK</th><th>QTY</th><th class="al-right">HARGA</th><th class="al-right">SUBTOTAL</th></tr></thead><tbody>${itemHtml}${paymentRows}</tbody></table>
    <div class="footer">Dokumen ini merupakan bukti transaksi yang sah dari ${CONFIG.STORE.NAME}.<br>Terima kasih atas kepercayaan Anda.</div>
    </td></tr></tbody></table>
    </body></html>`; 
    const safeInv = invNo.replace(/\//g, '-');
    return createPdfResult(html, `${safeInv} - ${customerName}.pdf`); 
  } catch (e) { return { success: false, message: e.message }; } 
}

// 2. MONTHLY REPORT (UPDATED: Accepts Month/Year)
function generatePDFReport(params) { 
  try { 
    const ss = SpreadsheetApp.openById(CONFIG.SS_ID); 
    
    // Determine target date
    const now = new Date();
    let targetMonth = now.getMonth();
    let targetYear = now.getFullYear();
    
    if (params && params.month != null) targetMonth = parseInt(params.month);
    if (params && params.year != null) targetYear = parseInt(params.year);
    
    const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    const sheetName = "Trans_" + monthNames[targetMonth] + targetYear;
    const sheet = ss.getSheetByName(sheetName); 
    
    let tOmzet=0, tProfit=0, tHPP=0, incomeRows=""; 
    if (sheet && sheet.getLastRow() > 1) { 
        sheet.getDataRange().getValues().slice(1).forEach((r, i) => { 
            const qty=Number(r[4]), modal=Number(r[6]), omzet=Number(r[7]), profit=Number(r[8]), hpp=modal*qty; 
            const dp=Number(r[9]), status=r[11];
            
            // LOGIC CASH BASIS: Profit = (LUNAS?Total:DP) - HPP
            const cashIn = (status === 'LUNAS') ? omzet : dp;
            tProfit += (cashIn - hpp); 
            tOmzet+=omzet; tHPP+=hpp; 
            incomeRows += `<tr><td class="al-center">${Utilities.formatDate(new Date(r[1]), CONFIG.TIMEZONE, "dd/MM")}</td><td class="al-left"><b>${r[3]}</b><br><span class="sub-text">${r[2]}</span></td><td class="al-center">${qty}</td><td class="al-right text-red">${modal.toLocaleString('id-ID')}</td><td class="al-right text-green">${profit.toLocaleString('id-ID')}</td><td class="al-right font-bold text-blue">${omzet.toLocaleString('id-ID')}</td></tr>`; 
        }); 
    } 
    let tExpense=0, expenseRows=""; 
    const sExp = ss.getSheetByName(CONFIG.SHEET_EXPENSE); 
    const targetDateStr = monthNames[targetMonth] + targetYear; // e.g. "Jan2026"
    
    if (sExp && sExp.getLastRow() > 1) { 
        sExp.getDataRange().getValues().slice(1).forEach(r => { 
            if(Utilities.formatDate(new Date(r[1]), CONFIG.TIMEZONE, "MMMyyyy") === targetDateStr) { 
                tExpense+=Number(r[4]); 
                expenseRows+=`<tr><td class="al-center">${Utilities.formatDate(new Date(r[1]), CONFIG.TIMEZONE, "dd/MM")}</td><td class="al-center">${r[2]}</td><td class="al-left">${r[3]}</td><td class="al-right text-orange">${Number(r[4]).toLocaleString('id-ID')}</td></tr>`; 
            } 
        }); 
    } 
    
    // Display Date
    const displayDate = monthNames[targetMonth] + " " + targetYear;
    const nowStr = Utilities.formatDate(new Date(), CONFIG.TIMEZONE, "dd-MM-yyyy");
    const html = `<!DOCTYPE html><html><head><style>${CONFIG.STYLE}</style></head><body>${getHeaderHTML("LAPORAN BULANAN", sheetName, displayDate)}
    <table class="summary-grid"><tr><td class="card bg-blue"><div class="card-lbl">Omzet</div><div class="card-val text-blue">Rp ${tOmzet.toLocaleString('id-ID')}</div></td><td class="card bg-red"><div class="card-lbl">Modal</div><div class="card-val text-red">(${tHPP.toLocaleString('id-ID')})</div></td><td class="card bg-orange"><div class="card-lbl">Biaya</div><div class="card-val text-orange">(${tExpense.toLocaleString('id-ID')})</div></td><td class="card bg-green"><div class="card-lbl">Profit</div><div class="card-val text-green">Rp ${(tProfit-tExpense).toLocaleString('id-ID')}</div></td></tr></table>
    <div class="section-head">PENJUALAN</div><table class="data-table"><colgroup><col style="width:10%"><col style="width:30%"><col style="width:8%"><col style="width:17%"><col style="width:17%"><col style="width:18%"></colgroup><thead><tr><th>TGL</th><th>ITEM</th><th>QTY</th><th class="al-right">MODAL</th><th class="al-right">PROFIT</th><th class="al-right">TOTAL</th></tr></thead><tbody>${incomeRows}</tbody><tr class="total-row"><td colspan="5" class="al-right">TOTAL OMZET</td><td class="al-right text-blue">Rp ${tOmzet.toLocaleString('id-ID')}</td></tr></table>
    <div class="section-head">PENGELUARAN</div><table class="data-table"><colgroup><col style="width:15%"><col style="width:25%"><col style="width:35%"><col style="width:25%"></colgroup><thead><tr><th>TGL</th><th>KATEGORI</th><th>KET</th><th class="al-right">NOMINAL</th></tr></thead><tbody>${expenseRows||'<tr><td colspan="4" class="al-center">- Kosong -</td></tr>'}</tbody><tr class="total-row"><td colspan="3" class="al-right">TOTAL BIAYA</td><td class="al-right text-orange">Rp ${tExpense.toLocaleString('id-ID')}</td></tr></table>
    <div class="footer">Dicetak otomatis oleh Grow System pada ${Utilities.formatDate(new Date(), CONFIG.TIMEZONE, "dd MMM yyyy HH:mm")}</div>
    </td></tr></tbody></table>
    </body></html>`; 
    return createPdfResult(html, `${nowStr} - Laporan ${sheetName}.pdf`); 
  } catch (e) { return { success: false, message: e.message }; } 
}

// 3. ANNUAL REPORT
function generateAnnualReport(params) { 
  try { 
    // Handle both object param (new) and raw value (old)
    let year = params;
    if (typeof params === 'object' && params.year) year = params.year;
    
    const ss = SpreadsheetApp.openById(CONFIG.SS_ID); const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]; let tOmzet=0, tProfit=0, tHPP=0, tTotalExp=0, summaryRows="", detailRows=""; let monthlyExp = {}; const sExp = ss.getSheetByName(CONFIG.SHEET_EXPENSE); if(sExp && sExp.getLastRow() > 1) { sExp.getDataRange().getValues().slice(1).forEach(r => { if (new Date(r[1]).getFullYear() == year) { const m = Utilities.formatDate(new Date(r[1]), CONFIG.TIMEZONE, "MMM"); monthlyExp[m] = (monthlyExp[m]||0) + Number(r[4]); } }); } 
    months.forEach(m => { 
        const sheet = ss.getSheetByName(`Trans_${m}${year}`); 
        let mOmzet=0, mProfit=0, mHPP=0; 
        
        if (sheet && sheet.getLastRow() > 1) { 
            sheet.getDataRange().getValues().slice(1).forEach(r => { 
                const qty=Number(r[4]), modal=Number(r[6]), omzet=Number(r[7]), profit=Number(r[8]), hpp=modal*qty; 
                const dp=Number(r[9]), status=r[11]; // LOGIC CASH BASIS
                const cashIn = (status === 'LUNAS') ? omzet : dp;
                const itemProfit = cashIn - hpp;
                mOmzet+=omzet; mProfit+=itemProfit; mHPP+=hpp; 
                detailRows += `<tr><td class="al-center">${Utilities.formatDate(new Date(r[1]), CONFIG.TIMEZONE, "dd/MM")}</td><td class="al-left"><b>${r[3]}</b></td><td class="al-center">${qty}</td><td class="al-right text-red">${modal.toLocaleString('id-ID')}</td><td class="al-right text-green">${profit.toLocaleString('id-ID')}</td><td class="al-right text-blue">${omzet.toLocaleString('id-ID')}</td></tr>`; 
            }); 
        } 
        const mExp = monthlyExp[m] || 0; 
        tOmzet+=mOmzet; tProfit+=mProfit; tHPP+=mHPP; tTotalExp+=mExp; 
        if (mOmzet > 0 || mExp > 0) { summaryRows += `<tr><td class="al-center font-bold">${m} ${year}</td><td class="al-right text-blue">${mOmzet.toLocaleString('id-ID')}</td><td class="al-right text-red">(${mHPP.toLocaleString('id-ID')})</td><td class="al-right text-orange">(${mExp.toLocaleString('id-ID')})</td><td class="al-right text-green font-bold">${(mProfit-mExp).toLocaleString('id-ID')}</td></tr>`; } 
    }); 
    const nowStr = Utilities.formatDate(new Date(), CONFIG.TIMEZONE, "dd-MM-yyyy");
    const html = `<!DOCTYPE html><html><head><style>${CONFIG.STYLE}</style></head><body>${getHeaderHTML("LAPORAN TAHUNAN", `TAHUN ${year}`, Utilities.formatDate(new Date(), CONFIG.TIMEZONE, "dd MMM yyyy"))}
    <table class="summary-grid"><tr><td class="card bg-blue"><div class="card-lbl">Omzet</div><div class="card-val text-blue">Rp ${tOmzet.toLocaleString('id-ID')}</div></td><td class="card bg-red"><div class="card-lbl">Modal</div><div class="card-val text-red">(${tHPP.toLocaleString('id-ID')})</div></td><td class="card bg-orange"><div class="card-lbl">Biaya</div><div class="card-val text-orange">(${tTotalExp.toLocaleString('id-ID')})</div></td><td class="card bg-green"><div class="card-lbl">Profit</div><div class="card-val text-green">Rp ${(tProfit-tTotalExp).toLocaleString('id-ID')}</div></td></tr></table>
    <div class="section-head">REKAPITULASI</div><table class="data-table"><colgroup><col style="width:20%"><col style="width:20%"><col style="width:20%"><col style="width:20%"><col style="width:20%"></colgroup><thead><tr><th>BULAN</th><th class="al-right">OMZET</th><th class="al-right">MODAL</th><th class="al-right">BIAYA</th><th class="al-right">NET</th></tr></thead><tbody>${summaryRows}</tbody><tr class="total-row"><td class="al-center">TOTAL</td><td class="al-right text-blue">${tOmzet.toLocaleString('id-ID')}</td><td class="al-right">(${tHPP.toLocaleString('id-ID')})</td><td class="al-right text-orange">(${tTotalExp.toLocaleString('id-ID')})</td><td class="al-right text-green">${(tProfit-tTotalExp).toLocaleString('id-ID')}</td></tr></table>
    <div class="section-head">RINCIAN TRANSAKSI</div><table class="data-table"><colgroup><col style="width:10%"><col style="width:30%"><col style="width:8%"><col style="width:17%"><col style="width:17%"><col style="width:18%"></colgroup><thead><tr><th>TGL</th><th>ITEM</th><th>QTY</th><th class="al-right">MODAL</th><th class="al-right">PROFIT</th><th class="al-right">TOTAL</th></tr></thead><tbody>${detailRows}</tbody></table>
    <div class="footer">Dicetak otomatis oleh Grow System pada ${Utilities.formatDate(new Date(), CONFIG.TIMEZONE, "dd MMM yyyy HH:mm")}</div>
    </td></tr></tbody></table>
    </body></html>`; 
    return createPdfResult(html, `${nowStr} - Laporan Tahunan ${year}.pdf`); 
  } catch (e) { return { success: false, message: e.message }; } 
}

// 4. EXPENSE ONLY
function generateExpenseOnlyReport(params) { 
  try { 
    const ss = SpreadsheetApp.openById(CONFIG.SS_ID); 
    const sExp = ss.getSheetByName(CONFIG.SHEET_EXPENSE); 
    
    // Parse Date
    const now = new Date();
    let targetMonth = now.getMonth();
    let targetYear = now.getFullYear();
    if (params && params.month != null) targetMonth = parseInt(params.month);
    if (params && params.year != null) targetYear = parseInt(params.year);
    
    const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    const targetDateStr = monthNames[targetMonth] + targetYear; // e.g. "Jan2026"
    const displayDate = monthNames[targetMonth] + " " + targetYear;
    
    let rows = "", totalExp = 0; 
    if(sExp) sExp.getDataRange().getValues().slice(1).forEach(r => { 
        if(Utilities.formatDate(new Date(r[1]), CONFIG.TIMEZONE, "MMMyyyy") === targetDateStr) { 
            totalExp += Number(r[4]); 
            rows += `<tr><td class="al-center">${Utilities.formatDate(new Date(r[1]), CONFIG.TIMEZONE, "dd/MM")}</td><td class="al-center">${r[2]}</td><td class="al-left">${r[3]}</td><td class="al-right">Rp ${Number(r[4]).toLocaleString('id-ID')}</td></tr>`; 
        } 
    }); 
    const nowStr = Utilities.formatDate(new Date(), CONFIG.TIMEZONE, "dd-MM-yyyy");
    const html = `<!DOCTYPE html><html><head><style>${CONFIG.STYLE}</style></head><body>${getHeaderHTML("LAPORAN PENGELUARAN", displayDate, "")}<div class="summary-grid"><div class="card bg-orange"><div class="card-lbl text-orange">TOTAL PENGELUARAN</div><div class="card-val text-orange">Rp ${totalExp.toLocaleString('id-ID')}</div></div></div><div class="section-head">RINCIAN DETAIL</div><table class="data-table"><colgroup><col style="width:15%"><col style="width:25%"><col style="width:35%"><col style="width:25%"></colgroup><thead><tr><th>TGL</th><th>KATEGORI</th><th>KETERANGAN</th><th class="al-right">NOMINAL</th></tr></thead><tbody>${rows}</tbody><tr class="total-row"><td colspan="3" class="al-right">TOTAL</td><td class="al-right text-orange">Rp ${totalExp.toLocaleString('id-ID')}</td></tr></table>
    <div class="footer">Dicetak otomatis oleh Grow System pada ${Utilities.formatDate(new Date(), CONFIG.TIMEZONE, "dd MMM yyyy HH:mm")}</div>
    </td></tr></tbody></table>
    </body></html>`; 
    return createPdfResult(html, `${nowStr} - Laporan Pengeluaran ${displayDate}.pdf`); 
  } catch (e) { return { success: false, message: e.message }; } 
}

function cleanUpDatabase() { const ss = SpreadsheetApp.openById(CONFIG.SS_ID); ss.getSheets().forEach(s => { try { const r=s.getLastRow(), c=s.getLastColumn(), mr=s.getMaxRows(), mc=s.getMaxColumns(); if(mr>r+20) s.deleteRows(r+20, mr-r-20); if(mc>c+2) s.deleteColumns(c+2, mc-c-2); } catch(e){} }); return "Cleaned"; }
